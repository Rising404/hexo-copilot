# Markdown 预览崩溃问题修复

## 问题描述
在开启 Markdown 预览功能时，编辑时页面容易黑屏，可能是崩溃或断连导致。

## 已实施的修复措施

### 1. ✅ 添加错误边界 (Error Boundary)
- 创建了 `ErrorBoundary` 组件捕获渲染错误
- 在整个应用外层添加了顶级错误边界
- 在预览区域添加了局部错误边界

**效果：**
- 当预览组件崩溃时，只会显示错误提示，不会导致整个页面黑屏
- 用户可以看到错误信息并重新加载，而不需要刷新整个页面

### 2. ✅ MarkdownPreview 组件错误处理
- 添加了 try-catch 捕获渲染错误
- 添加了渲染错误状态管理
- 提供错误信息展示和重试功能

**防护机制：**
```typescript
try {
  return <ReactMarkdown>{content}</ReactMarkdown>;
} catch (error) {
  setRenderError(error.message);
  return null;
}
```

### 3. ✅ 图片加载错误处理
- 为所有图片添加 `onError` 处理
- 图片加载失败时显示友好的错误提示
- 防止图片错误导致组件崩溃

**保护措施：**
```typescript
<img 
  onError={(e) => {
    // 隐藏失败的图片，显示错误提示
    e.currentTarget.style.display = 'none';
    // 插入错误提示元素
  }}
/>
```

### 4. ✅ 预览内容验证
- 在渲染前检查内容是否为空
- 空内容时显示提示信息而不是尝试渲染

## 可能导致崩溃的常见原因

### 1. 复杂的 KaTeX 数学公式
**问题：** 某些复杂或错误的 LaTeX 公式可能导致 KaTeX 渲染失败

**示例可能有问题的公式：**
```markdown
$$
\frac{1}{0}  <!-- 数学上无意义 -->
$$

$$
\undefined_command  <!-- 未定义的命令 -->
$$
```

**解决方案：**
- KaTeX 已设置 `throwOnError: false`，会显示原始公式而不崩溃
- 检查公式语法是否正确

### 2. 错误的图片路径
**问题：** 图片路径解析错误或文件不存在

**现在的处理：**
- 图片加载失败时不会崩溃
- 显示友好的错误提示

### 3. 特殊 Markdown 语法
**问题：** 某些极端的 Markdown 语法可能导致解析器崩溃

**现在的处理：**
- ErrorBoundary 会捕获任何渲染错误
- 显示错误信息而不是黑屏

### 4. 内存/性能问题
**问题：** 超大文档或频繁渲染导致性能问题

**已有优化：**
- 300ms 防抖延迟更新预览
- React.memo 避免不必要的重渲染
- 限制撤销历史栈大小

## 调试建议

### 如果仍然遇到黑屏问题：

1. **打开浏览器开发者工具 (F12)**
   - 查看 Console 标签页的错误信息
   - 查看 Network 标签页是否有请求失败

2. **检查最近的编辑内容**
   - 尝试删除或注释最近添加的内容
   - 特别注意数学公式和图片

3. **测试步骤：**
   ```markdown
   1. 创建一个新的简单文件测试
   2. 逐步添加内容，观察何时开始出现问题
   3. 定位到具体的问题内容
   ```

4. **检查后端连接**
   ```bash
   # 确保后端正在运行
   # 访问 http://127.0.0.1:8000/api/config
   # 应该返回配置信息
   ```

5. **查看错误边界信息**
   - 现在崩溃时会显示错误信息
   - 记录错误消息以便排查

## 性能监控建议

### 使用 React DevTools
1. 安装 React Developer Tools 浏览器扩展
2. 打开 Profiler 标签页
3. 录制编辑过程
4. 查看哪些组件渲染频繁

### 检查内存使用
1. 打开 Chrome 任务管理器 (Shift+Esc)
2. 观察标签页的内存使用
3. 如果持续增长可能有内存泄漏

## 后续优化方向

### 可以考虑的进一步优化：

1. **虚拟滚动**
   - 对于超长文档，只渲染可见区域

2. **增量渲染**
   - 只重新渲染改变的部分

3. **Web Worker**
   - 在后台线程处理 Markdown 解析

4. **更细粒度的错误处理**
   - 为每个 Markdown 元素添加错误边界

## 常见问题排查

### Q: 页面完全黑屏，无任何提示
**A:** 
- 刷新页面 (F5)
- 检查浏览器控制台错误
- 确保后端服务正在运行
- 顶级 ErrorBoundary 应该会捕获并显示错误

### Q: 预览区显示红色错误提示
**A:**
- 这是正常的错误处理机制
- 查看错误信息
- 点击"重新尝试"按钮
- 检查并修复导致错误的内容

### Q: 图片显示黄色警告
**A:**
- 图片加载失败
- 检查图片路径是否正确
- 确保图片文件存在
- 检查后端 API 是否正常

### Q: 编辑时仍然卡顿
**A:**
- 检查文档大小（建议 < 10000 行）
- 关闭不必要的浏览器扩展
- 尝试关闭同步滚动功能
- 考虑拆分为多个较小的文件

## 紧急恢复步骤

如果应用完全无法使用：

1. **清除浏览器缓存**
   ```
   Ctrl+Shift+Delete
   清除缓存和数据
   ```

2. **重启后端服务**
   ```powershell
   # 停止当前服务
   # 重新运行
   .\Start-HexoCopilot.ps1
   ```

3. **检查文件完整性**
   ```bash
   # 确保所有组件文件存在
   ls components/
   # 应该看到：
   # - ErrorBoundary.tsx
   # - MathRenderer.tsx
   # - 等等
   ```

4. **回退到之前的版本**
   - 如果使用 Git，回退到稳定版本
   ```bash
   git log
   git checkout <stable-commit>
   ```
